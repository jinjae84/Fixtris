#define _CRT_SECURE_NO_WARNINGS
#include <stdio.h>
#include <time.h>
#include <Windows.h>
#include <conio.h>
#include <stdbool.h>

#define WIDTH 34
#define HEIGHT 34

clock_t startDropT, endT, startGroundT;
int x = 8, y = 0;
RECT blockSize;
int blockForm;
int blockRotation = 0;
int key;
char buffer[HEIGHT * (WIDTH * 2 + 1) + 1];

char block[7][4][4][4] = 
{
  {
	{
		{'0', '0', '0', '0'},
	    {'0', '1', '0', '0'},
	    {'1', '1', '1', '0'},
		{'0', '0', '0', '0'}
    },
	{
		{'0', '0', '0', '0'},
		{'0', '1', '0', '0'},
		{'0', '1', '1', '0'},
		{'0', '1', '0', '0'}
    },
    {
		{'0', '0', '0', '0'},
		{'0', '0', '0', '0'},
		{'1', '1', '1', '0'},
		{'0', '1', '0', '0'}
    },
	{
		{'0', '0', '0', '0'},
		{'0', '1', '0', '0'},
		{'1', '1', '0', '0'},
		{'0', '1', '0', '0'}
    }
  },
  {    
		{
			{'0', '0', '0', '0'},
			{'0', '1', '1', '0'},
			{'1', '1', '0', '0'},
			{'0', '0', '0', '0'}
		},
		{
			{'0', '0', '0', '0'},
			{'1', '0', '0', '0'},
			{'1', '1', '0', '0'},
			{'0', '1', '0', '0'}
		},
		{
			{'0', '0', '0', '0'},
			{'0', '1', '1', '0'},
			{'1', '1', '0', '0'},
			{'0', '0', '0', '0'}
		},
		{
			{'0', '0', '0', '0'},
			{'1', '0', '0', '0'},
			{'1', '1', '0', '0'},
			{'0', '1', '0', '0'}
		}
  },
  {   
		{
			{'0', '0', '0', '0'},
			{'1', '1', '0', '0'},
			{'0', '1', '1', '0'},
			{'0', '0', '0', '0'}
		},
		{
			{'0', '0', '0', '0'},
			{'0', '1', '0', '0'},
			{'1', '1', '0', '0'},
			{'1', '0', '0', '0'}
		},
		{
			{'0', '0', '0', '0'},
			{'1', '1', '0', '0'},
			{'0', '1', '1', '0'},
			{'0', '0', '0', '0'}
		},
		{
			{'0', '0', '0', '0'},
			{'0', '1', '0', '0'},
			{'1', '1', '0', '0'},
			{'1', '0', '0', '0'}
		}
  },
  {   
		{
			{'0', '1', '0', '0'},
			{'0', '1', '0', '0'},
			{'0', '1', '0', '0'},
			{'0', '1', '0', '0'}
		},
		{
			{'0', '0', '0', '0'},
			{'0', '0', '0', '0'},
			{'1', '1', '1', '1'},
			{'0', '0', '0', '0'}
		},
		{
			{'0', '1', '0', '0'},
			{'0', '1', '0', '0'},
			{'0', '1', '0', '0'},
			{'0', '1', '0', '0'}
		},
		{
			{'0', '0', '0', '0'},
			{'0', '0', '0', '0'},
			{'1', '1', '1', '1'},
			{'0', '0', '0', '0'}
		}
  },
  {   
		{
			{'0', '0', '0', '0'},
			{'1', '0', '0', '0'},
			{'1', '1', '1', '0'},
			{'0', '0', '0', '0'}
		},
		{
			{'0', '0', '0', '0'},
			{'1', '1', '0', '0'},
			{'1', '0', '0', '0'},
			{'1', '0', '0', '0'}
		},
		{
			{'0', '0', '0', '0'},
			{'1', '1', '1', '0'},
			{'0', '0', '1', '0'},
			{'0', '0', '0', '0'}
		},
		{
			{'0', '1', '0', '0'},
			{'0', '1', '0', '0'},
			{'1', '1', '0', '0'},
			{'0', '0', '0', '0'}
		}
  },
  {   
		{
			{'0', '0', '0', '0'},
			{'0', '0', '1', '0'},
			{'1', '1', '1', '0'},
			{'0', '0', '0', '0'}
		},
		{
			{'1', '0', '0', '0'},
			{'1', '0', '0', '0'},
			{'1', '1', '0', '0'},
			{'0', '0', '0', '0'}
		},
		{
			{'0', '0', '0', '0'},
			{'1', '1', '1', '0'},
			{'1', '0', '0', '0'},
			{'0', '0', '0', '0'}
		},
		{
			{'0', '0', '0', '0'},
			{'1', '1', '0', '0'},
			{'0', '1', '0', '0'},
			{'0', '1', '0', '0'}
		}
  },
  {   
		{
			{'0', '0', '0', '0'},
			{'0', '1', '1', '0'},
			{'0', '1', '1', '0'},
			{'0', '0', '0', '0'}
		},
		{
			{'0', '0', '0', '0'},
			{'0', '1', '1', '0'},
			{'0', '1', '1', '0'},
			{'0', '0', '0', '0'}
		},
		{
			{'0', '0', '0', '0'},
			{'0', '1', '1', '0'},
			{'0', '1', '1', '0'},
			{'0', '0', '0', '0'}
		},
		{
			{'0', '0', '0', '0'},
			{'0', '1', '1', '0'},
			{'0', '1', '1', '0'},
			{'0', '0', '0', '0'}
		}
  }
};

char map[HEIGHT][WIDTH] =
{
	{'1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '1', '1', '1', '1', '1', '1', '1', '1', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1'},
	{'1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1'},
	{'1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1'},
	{'1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1'},
	{'1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1'},
	{'1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1'},
	{'1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1'},
	{'1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1'},
	{'1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1'},
	{'1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '1', '1', '1', '1', '1', '1', '1', '1', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1'},
	{'1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1'},
	{'1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1'},
	{'1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1'},
	{'1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1'},
	{'1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1'},
	{'1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1'},
	{'1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1'},
	{'1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1'},
	{'1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1'},
	{'1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1'},
	{'1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1'},
	{'1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1'},
	{'1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1'},
	{'1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1'},
	{'1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1'},
	{'1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1'},
	{'1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1'},
	{'1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1'},
	{'1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1'},
	{'1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1'},
	{'1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1'},
	{'1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1'},
	{'1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '1', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '1'},
	{'1', '1', '1', '1', '1', '1', '1', '1', '1', '1', '1', '1', '1', '1', '1', '1', '1', '1', '1', '1', '1', '1', '1', '1', '1', '1', '1', '1', '1', '1', '1', '1', '1', '1'}

	
};

void init()
{
	CONSOLE_CURSOR_INFO cursorInfo;
	cursorInfo.bVisible = 0;
	cursorInfo.dwSize = 1;
	SetConsoleCursorInfo(GetStdHandle(STD_OUTPUT_HANDLE), &cursorInfo);
	srand(time(NULL));
}

void gotoxy(int x, int y)
{
	COORD position;
	position.X = x;
	position.Y = y;
	SetConsoleCursorPosition(GetStdHandle(STD_OUTPUT_HANDLE), position);
}

void RandomForm()
{
	blockForm = rand() % 7;
}

bool CheckCrash(int x, int y)
{
	for (int i = 0; i < 4; i++)
	{
		for (int j = 0; j < 4; j++)
		{
			if (block[blockForm][blockRotation][i][j] == 1)
			{
				int t = map[i + y][j + x / 2];
				if (t == '1' || t == '2')
				{
					return true;
				}
			}
		}
	}
	return false;
}

void DropBlock()
{
	endT = clock();
	if ((float)(endT - startDropT) >= 800)
	{
		if (CheckCrash(x, y + 1) == true)
		{
			BlockToGround();
			RandomForm();
		}
		else
		{
			y++;
		}
		startDropT = clock();

	}
}

void BlockToGround()
{
	for (int i = 0; i < 4; i++)
	{
		for (int j = 0; j < 4; j++)
		{
			if (block[blockForm][blockRotation][i][j] == '1')
			{
				map[i + y][j + x / 2] = '2';  // '2'는 고정된 블록을 의미
			}
		}
	}
	x = 8;  // 새 블록의 x 위치 초기화
	y = 0;  // 새 블록의 y 위치 초기화
	RandomForm();  // 새 블록 생성
	startGroundT = clock();  // 땅에 닿은 시간 기록
}

void RenderToBuffer()
{
	int idx = 0;
	gotoxy(0, 0);
	for (int i = 0; i < HEIGHT; i++)
	{
		for (int j = 0; j < WIDTH; j++)
		{
			if (map[i][j] == '1')
			{				
				sprintf(&buffer[idx], "□"); 
				idx += 2;
			}

			else if (map[i][j] == '2')
			{
				sprintf(&buffer[idx], "■"); 
				idx += 2;
			}

			else
			{
				sprintf(&buffer[idx], "  "); 
				idx += 2;
			}
		}
		sprintf(&buffer[idx], "\n"); // 줄 바꿈
		idx++;
	}
	buffer[idx] = '\0';
}

void DrawBlock()
{
	for (int i = 0; i < 4; i++)
	{
		for (int j = 0; j < 4; j++)
		{
			if (block[blockForm][blockRotation][i][j] == '1')
			{
				gotoxy(x + j * 2, y + i);
				printf("■");
			}
		}
	}
}

void InputKey()
{
	if (_kbhit())
	{
		key = _getch();
		switch (key)
		{
		case 32: // space
			blockRotation++;
			if (blockRotation >= 4) blockRotation = 0;
			startGroundT = clock();
			break;
		case 75: // left
			if (CheckCrash(x - 2, y) == false)
			{
				x -= 2;
				startGroundT = clock();
			}
			break;
		case 77: // right
			if (CheckCrash(x + 2, y) == false)
			{
				x += 2;
				startGroundT = clock();
			}
			break;
		case 80: // down
			if (CheckCrash(x, y + 1) == false)
				y++;
			break;
		}
		system("cls");
	}
}

void Render()
{
	RenderToBuffer();
	gotoxy(0, 0);
	printf("%s", buffer);
}

 int main()
 {
	init();
	startDropT = clock();
	RandomForm();
 
	while (true)
	{
		Render();
		DrawBlock();
		DropBlock();
		BlockToGround();
		InputKey();
	}

 	return 0;
 }